<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mara Pilot Logbook</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0b1a33">

  <!-- iOS Home Screen -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Mara Logbook">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <style>
    /* =========================
       Mara Logbook UI
       - 10 rows per page
       - ALL CAPS always
       - TAB on empty time copies previous H:MM
       - Totals rows highlighted (yellow both themes)
       - Added FSTD totals in footer rows
       - Header: IFR (renamed from IFR ACTUAL)
       - Panel title: TOTAL FROM PREVIOUS PAGE
       - REMOVED: SE, ME, MULTI PILOT columns and previous totals fields
       ========================= */

    :root{
      /* DARK default */
      --bg:#071326;
      --panel:rgba(10,24,50,.72);
      --panel2:rgba(10,24,50,.55);
      --ink:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --line:rgba(234,240,255,.10);
      --line2:rgba(234,240,255,.06);

      --gold:#d9bb62;
      --gold2:#caa84a;

      --danger:#d06b5f;
      --ok:#59c18d;

      --thead:rgba(8,20,45,.72);
      --row:rgba(255,255,255,.02);
      --rowAlt:rgba(255,255,255,.035);
      --rowHover:rgba(217,187,98,.08);

      --shadow:0 24px 80px rgba(0,0,0,.35);
      --totals-accent:var(--gold);
    }

    body.light{
      /* LIGHT */
      --bg:#eef3ff;
      --panel:rgba(255,255,255,.92);
      --panel2:rgba(255,255,255,.82);
      --ink:#0b1a33;
      --muted:rgba(11,26,51,.70);
      --line:rgba(11,26,51,.12);
      --line2:rgba(11,26,51,.06);

      /* same yellow */
      --gold:#d9bb62;
      --gold2:#caa84a;
      --totals-accent:var(--gold);

      --thead:rgba(234,241,255,.95);
      --row:rgba(255,255,255,.98);
      --rowAlt:rgba(245,248,255,.98);
      --rowHover:rgba(217,187,98,.10);

      --shadow:0 24px 70px rgba(10,25,60,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(1200px 600px at 20% 15%, rgba(14,60,120,.25), transparent 55%),
        radial-gradient(1000px 550px at 80% 20%, rgba(30,80,170,.18), transparent 58%),
        radial-gradient(900px 700px at 60% 80%, rgba(0,0,0,.35), transparent 60%),
        var(--bg);
      color:var(--ink);
      overflow-x:hidden;
    }

    .app{max-width:1500px;margin:0 auto;padding:18px 14px 30px}

    /* ===== header ===== */
    .topbar{
      position:sticky;top:10px;z-index:50;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border:1px solid var(--line2);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.01));
      backdrop-filter:blur(12px);
      border-radius:16px;
      padding:14px 14px;
      box-shadow:var(--shadow);
    }

    .brand{display:flex;flex-direction:column;gap:4px;min-width:260px}
    .brand .title{
      display:flex;align-items:center;gap:10px;
      font-weight:1000;
      letter-spacing:4px;
      text-transform:uppercase;
      white-space:nowrap;
      font-size:20px;
    }
    .brand .sub{
      font-size:11px;
      letter-spacing:3px;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:1000;
    }

    .kpis{
      display:flex;align-items:center;justify-content:center;
      gap:14px;flex:1;flex-wrap:wrap;min-width:320px;
    }
    .kpi{
      min-width:150px;text-align:center;
      padding:10px 12px;border-radius:14px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line2);
    }
    .kpi .v{
      font-weight:1000;
      font-size:22px;
      letter-spacing:1px;
      color:var(--gold);
      font-variant-numeric:tabular-nums;
    }
    .kpi .l{
      margin-top:3px;
      font-size:11px;
      letter-spacing:3px;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:1000;
    }

    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--ink);
      padding:10px 14px;
      font-weight:1000;
      font-size:12px;
      letter-spacing:1px;
      cursor:pointer;
      transition:transform .12s, background .12s, border-color .12s, opacity .12s;
      white-space:nowrap;
      text-transform:uppercase;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(217,187,98,.35)}
    .btn:active{transform:translateY(0);opacity:.9}
    .btn.gold{background:linear-gradient(180deg,var(--gold),var(--gold2));color:#1b1b1b;border-color:transparent}
    .btn.danger{background:rgba(208,107,95,.12);border-color:rgba(208,107,95,.30);color:var(--danger)}
    .btn.ok{background:rgba(89,193,141,.12);border-color:rgba(89,193,141,.30);color:var(--ok)}
    .btn.small{padding:9px 12px;min-width:44px}

    /* ===== panels ===== */
    .panel{
      margin-top:14px;border-radius:16px;overflow:hidden;
      border:1px solid var(--line2);
      background:var(--panel);
      box-shadow:var(--shadow);
    }
    .panel-h{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;gap:10px;flex-wrap:wrap;
      background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      border-bottom:1px solid var(--line2);
    }
    .panel-h .left{
      display:flex;align-items:center;gap:10px;
      font-weight:1000;letter-spacing:3px;text-transform:uppercase;
      font-size:12px;color:var(--muted);white-space:nowrap;
    }
    .panel-h .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

    /* ===== prev totals fields ===== */
    .prev-grid{
      padding:14px;
      display:grid;
      grid-template-columns:repeat(5, minmax(0,1fr));
      gap:12px;
    }
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{
      font-size:10px;letter-spacing:3px;text-transform:uppercase;
      color:var(--muted);font-weight:1000;
    }
    .field input{
      height:40px;border-radius:12px;border:1px solid var(--line2);
      background:rgba(255,255,255,.02);
      color:var(--ink);
      padding:10px 12px;
      font-weight:1000;
      outline:none;
      font-variant-numeric:tabular-nums;
      text-transform:uppercase;
    }
    body.light .field input{background:rgba(255,255,255,.92)}
    .field input:focus{border-color:rgba(217,187,98,.45)}

    /* ===== table ===== */
    .table-wrap{width:100%;overflow:auto;background:var(--panel2)}
    table{
      width:100%;
      min-width:1720px;
      border-collapse:collapse;
      font-size:11px;
      font-variant-numeric:tabular-nums;
    }
    th,td{
      border:1px solid var(--line2);
      padding:8px 6px;
      text-align:center;
      vertical-align:middle;
      white-space:nowrap;
    }
    thead th{
      background:var(--thead);
      color:var(--muted);
      font-weight:1000;
      text-transform:uppercase;
      letter-spacing:2px;
      font-size:10px;
    }
    tbody tr{background:var(--row)}
    tbody tr:nth-child(even){background:var(--rowAlt)}
    tbody tr:hover{background:var(--rowHover)}

    /* ALL CAPS */
    input, textarea, select{ text-transform:uppercase; }

    .cell{
      width:100%;border:none;outline:none;
      background:transparent;color:var(--ink);
      font-weight:1000;
      text-align:center;
      font-size:11px;
      padding:2px 0;
      text-transform:uppercase;
    }
    .cell::placeholder{color:rgba(160,180,220,.55);font-weight:900}
    body.light .cell::placeholder{color:rgba(90,110,150,.55)}
    .upper{letter-spacing:1px}
    .time{letter-spacing:1px}
    .small{font-size:10px}
    .cell:focus{background:rgba(217,187,98,.10);border-radius:8px}

    /* totals rows */
    tfoot td{background:rgba(255,255,255,.03);color:var(--muted);font-weight:1000}
    .tfLabel{
      text-align:left;padding-left:10px;
      letter-spacing:3px;text-transform:uppercase;
      color:var(--muted);font-size:10px;
    }
    .total-this td, .total-prev td{
      color:var(--totals-accent);
      background:rgba(217,187,98,.06);
    }
    .total-this .tfLabel, .total-prev .tfLabel{color:var(--totals-accent)}
    .grand td{
      border-top:2px solid rgba(217,187,98,.25);
      background:rgba(217,187,98,.10);
      color:var(--totals-accent);
      font-size:12px;
    }

    .del{
      border-radius:10px;border:1px solid rgba(208,107,95,.35);
      background:rgba(208,107,95,.12);
      color:var(--danger);
      cursor:pointer;font-weight:1000;
      padding:6px 10px;text-transform:uppercase;
    }

    /* ===== modal ===== */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:center;justify-content:center;
      padding:14px;z-index:100;backdrop-filter:blur(12px);
    }
    .overlay.open{display:flex}
    .modal{
      width:min(980px,100%);
      border-radius:18px;overflow:hidden;
      border:1px solid var(--line2);
      background:var(--panel);
      box-shadow:var(--shadow);
      max-height:calc(100vh - 28px);
      display:flex;flex-direction:column;
    }
    .modal-h{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 16px;border-bottom:1px solid var(--line2);
      background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      flex:0 0 auto;
    }
    .modal-h .t{
      font-weight:1000;letter-spacing:3px;text-transform:uppercase;color:var(--muted);
      display:flex;align-items:center;gap:10px;
    }
    .modal-b{
      padding:14px 16px;
      display:grid;grid-template-columns:1fr 1fr;gap:12px;
      overflow:auto;-webkit-overflow-scrolling:touch;
      flex:1 1 auto;
    }
    .scanRow{grid-column:1/-1;display:flex;gap:12px;flex-wrap:wrap}
    .scanBtn{
      flex:1;min-width:280px;
      border-radius:16px;padding:14px 14px;
      border:2px dashed rgba(118,169,255,.35);
      background:rgba(118,169,255,.08);
      color:var(--ink);
      font-weight:1000;letter-spacing:2px;text-transform:uppercase;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:10px;
    }
    .scanBtn.pdf{border-color:rgba(89,193,141,.35);background:rgba(89,193,141,.08)}
    .fileHidden{display:none}
    .hint{
      grid-column:1/-1;border:1px dashed var(--line);
      border-radius:14px;padding:10px 12px;
      color:var(--muted);font-size:12px;line-height:1.35;
      background:rgba(255,255,255,.03);
      text-transform:none;
    }
    .hint b{text-transform:uppercase}
    .preview{
      grid-column:1/-1;border-radius:14px;overflow:hidden;
      border:1px solid var(--line2);
      background:rgba(0,0,0,.08);
      display:none;max-height:240px;
    }
    .preview img{width:100%;display:block}
    .modal-actions{
      grid-column:1/-1;
      position:sticky;bottom:0;
      display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;
      padding:12px 0 6px;margin-top:6px;
      background:linear-gradient(180deg, transparent, rgba(0,0,0,.18));
    }
    body.light .modal-actions{background:linear-gradient(180deg, transparent, rgba(255,255,255,.92))}

    @media (max-width:1100px){.kpis{display:none}}
    @media (max-width:980px){
      .prev-grid{grid-template-columns:1fr 1fr}
      .modal-b{grid-template-columns:1fr}
      table{min-width:1600px}
    }

        @media print{
      .topbar,.panel-h .right,.del,.overlay{display:none !important}
      body{background:#fff}
      .panel{box-shadow:none;background:#fff}
      @page{size:A4 landscape;margin:10mm}
    }

    /* EASA FOOTER */
    .print-footer-easa{display:none}

    @media print{
      .print-footer-easa{
        display:block;
        position:fixed;
        bottom:5mm;
        left:0;
        width:100%;
        text-align:center;
        font-size:10px;
        font-weight:1000;
        letter-spacing:2px;
      }
    }

  </style>
  </style>
</head>

<body>
  <div class="app">
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
      }

    </script>

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="brand">
        <div class="title">âœˆ MARA PILOT LOGBOOK</div>
        <div class="sub">FLIGHT RECORD SYSTEM</div>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="v" id="k_total">0:00</div><div class="l">TOTAL TIME</div></div>
        <div class="kpi"><div class="v" id="k_pic">0:00</div><div class="l">PIC TIME</div></div>
        <div class="kpi"><div class="v" id="k_night">0:00</div><div class="l">NIGHT</div></div>
        <div class="kpi"><div class="v" id="k_ifr">0:00</div><div class="l">IFR</div></div>
      </div>

      <div class="actions">
        <button class="btn small" onclick="setPage(currentPage-1)">â—€</button>
        <button class="btn" id="pageLabel" style="min-width:130px">PAGE 1 / 1</button>
        <button class="btn small" onclick="setPage(currentPage+1)">â–¶</button>

        <button class="btn" id="themeBtn" onclick="toggleTheme()">LIGHT</button>
        <button class="btn gold" onclick="openModal()">+ ADD FLIGHT</button>
      </div>
    </div>

    <!-- TOTAL FROM PREVIOUS PAGE -->
    <div class="panel">
      <div class="panel-h">
        <div class="left">ðŸ“‹ TOTAL FROM PREVIOUS PAGE</div>
        <div class="right">
          <button class="btn ok" onclick="seedFromPhoto()">IMPORT (PHOTO PAGE)</button>
          <button class="btn" onclick="exportBackup()">BACKUP</button>
          <button class="btn" onclick="importBackup()">RESTORE</button>
          <button class="btn" onclick="window.print()">EXPORT PDF</button>
          <button class="btn danger" onclick="resetAll()">RESET</button>
        </div>
      </div>

      <div class="prev-grid" id="prevGrid"></div>
    </div>

    <!-- LOGBOOK TABLE -->
    <div class="panel">
      <div class="panel-h">
        <div class="left">ðŸ“˜ LOGBOOK PAGE (10 ROWS)</div>
        <div class="right">
          <span style="color:var(--muted);font-weight:1000;font-size:12px;letter-spacing:1px;text-transform:uppercase;">
            AUTO-SAVED LOCALLY â€¢ WORKS OFFLINE
          </span>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>DATE<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">DD.MM.YY</span></th>

              <th>DEP<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">PLACE</span></th>
              <th>DEP<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">TIME</span></th>

              <th>ARR<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">PLACE</span></th>
              <th>ARR<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">TIME</span></th>

              <th>AIRCRAFT<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">TYPE</span></th>
              <th>AIRCRAFT<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">REG</span></th>

              <th>NAME(S)<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">PIC</span></th>

              <th>TOTAL<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">FLIGHT</span></th>

              <!-- LDG columns behind TOTAL FLIGHT -->
              <th>DAY<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">LDG</span></th>
              <th>NIGHT<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">LDG</span></th>

              <th>NIGHT</th>
              <th>IFR</th>

              <th>PIC</th>
              <th>CO-PILOT</th>
              <th>DUAL</th>
              <th>FI</th>

              <th colspan="3">FSTD SESSION</th>

              <th>REMARKS & ENDORSEMENTS</th>
              <th></th>
            </tr>

            <tr>
              <th colspan="17"></th>
              <th>DATE<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">DD.MM.YY</span></th>
              <th>TYPE</th>
              <th>TOTAL<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">SESSION</span></th>
              <th colspan="2"></th>
            </tr>
          </thead>

          <tbody id="tbody"></tbody>
          <tfoot id="tfoot"></tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="overlay" id="overlay" onclick="overlayClick(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-h">
        <div class="t">âœˆ NEW FLIGHT ENTRY</div>
        <button class="btn" onclick="closeModal()">Close</button>
      </div>

      <div class="modal-b">
        <div class="scanRow">
          <button class="scanBtn" onclick="document.getElementById('photoInput').click()">ðŸ“· PHOTO SCAN</button>
          <button class="scanBtn pdf" onclick="document.getElementById('pdfInput').click()">ðŸ“„ PDF IMPORT</button>
          <input class="fileHidden" type="file" id="photoInput" accept="image/*">
          <input class="fileHidden" type="file" id="pdfInput" accept="application/pdf">
        </div>

        <div class="hint">
          <b>NOTE:</b> ON GITHUB PAGES THIS APP WORKS OFFLINE AND SAVES LOCALLY.
          PHOTO/PDF BUTTONS STORE A PREVIEW REFERENCE (NO AI EXTRACTION HERE WITHOUT A BACKEND).
          USE <b>IMPORT (PHOTO PAGE)</b> TO AUTO-FILL THE SAMPLE 10 FLIGHTS.
        </div>

        <div class="preview" id="photoPrev"></div>
        <div id="pdfName" style="grid-column:1/-1;color:var(--muted);font-weight:1000;letter-spacing:1px;"></div>

        <div class="field"><label>Date (DD.MM.YY)</label><input id="f_date" placeholder="23.11"></div>
        <div class="field"><label>Name(s) PIC</label><input id="f_name" placeholder="SELF"></div>

        <div class="field"><label>Dep Place (ICAO)</label><input id="f_dep" placeholder="RCTP"></div>
        <div class="field"><label>Dep Time (HHMM)</label><input id="f_out" placeholder="1300"></div>

        <div class="field"><label>Arr Place (ICAO)</label><input id="f_arr" placeholder="VTBS"></div>
        <div class="field"><label>Arr Time (HHMM)</label><input id="f_in" placeholder="1642"></div>

        <div class="field"><label>Aircraft Type</label><input id="f_type" placeholder="B781"></div>
        <div class="field"><label>Registration</label><input id="f_reg" placeholder="B-17812"></div>

        <div class="field"><label>Total Flight (H:MM)</label><input id="f_total" placeholder="AUTO"></div>
        <div class="field"><label>Night (H:MM)</label><input id="f_night" placeholder=""></div>

        <div class="field"><label>IFR (H:MM)</label><input id="f_ifr" placeholder="AUTO"></div>
        <div class="field"><label>PIC (H:MM)</label><input id="f_pic" placeholder="AUTO"></div>

        <div class="field"><label>Co-Pilot (H:MM)</label><input id="f_cop" placeholder=""></div>
        <div class="field"><label>Dual (H:MM)</label><input id="f_dual" placeholder=""></div>

        <div class="field"><label>FI (H:MM)</label><input id="f_fi" placeholder=""></div>
        <div class="field"><label>LDG Day</label><input id="f_ldg_day" type="number" min="0" placeholder="0"></div>

        <div class="field"><label>LDG Night</label><input id="f_ldg_night" type="number" min="0" placeholder="0"></div>
        <div class="field"><label>FSTD Date (DD.MM.YY)</label><input id="f_sim_date" placeholder="29.11.25"></div>

        <div class="field"><label>FSTD Type</label><input id="f_sim_type" placeholder="B789"></div>
        <div class="field"><label>FSTD Total (H:MM)</label><input id="f_sim_total" placeholder="3:00"></div>

        <div class="field" style="grid-column:1/-1"><label>Remarks & Endorsements</label><input id="f_rem" placeholder=""></div>

        <div class="modal-actions">
          <button class="btn" onclick="closeModal()">Cancel</button>
          <button class="btn gold" onclick="saveFromModal()">Save Flight</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Storage + State
   ========================= */
const KEY_FLIGHTS = "mara_book_flights_v6";
const KEY_PREV    = "mara_book_prev_v6";
const KEY_THEME   = "mara_book_theme_v6";
const KEY_ATTACH  = "mara_book_attach_v6";
const KEY_PAGE    = "mara_page_v5";
const ROWS_PER_PAGE = 10;

let currentPage = parseInt(localStorage.getItem(KEY_PAGE) || "1", 10);
if (!currentPage || currentPage < 1) currentPage = 1;

let flights = loadJSON(KEY_FLIGHTS, []);
let prev = loadJSON(KEY_PREV, {
  total: "0:00",
  night: "0:00",
  ifr: "0:00",
  pic: "0:00",
  cop: "0:00",
  dual: "0:00",
  fi: "",
  ldg_day: "0",
  ldg_night: "0",
  fstd: "0:00"
});
let attach = loadJSON(KEY_ATTACH, { photoDataUrl: "", pdfName: "" });

function loadJSON(k, fallback){
  try{
    const v = localStorage.getItem(k);
    if(!v) return fallback;
    return JSON.parse(v);
  }catch(e){ return fallback; }
}
function saveJSON(k, v){
  try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){}
}

/* =========================
   Page
   ========================= */
function setPage(p){
  currentPage = Math.max(1, p);
  localStorage.setItem(KEY_PAGE, String(currentPage));
  render();
}

/* =========================
   Theme
   ========================= */
function applyTheme(mode){
  if(mode === "light"){
    document.body.classList.add("light");
    document.getElementById("themeBtn").textContent = "DARK";
  }else{
    document.body.classList.remove("light");
    document.getElementById("themeBtn").textContent = "LIGHT";
  }
  localStorage.setItem(KEY_THEME, mode);
}
function toggleTheme(){
  const isLight = document.body.classList.contains("light");
  applyTheme(isLight ? "dark" : "light");
}

/* =========================
   Time utils + TAB copy previous time (H:MM)
   ========================= */
let _lastTimeValue = "";

function toMins(hhmm){
  if(!hhmm) return 0;
  const s = String(hhmm).trim();
  if(!s) return 0;
  if(s.includes(":")){
    const parts = s.split(":");
    return (parseInt(parts[0],10)||0)*60 + (parseInt(parts[1],10)||0);
  }
  const d = s.replace(/[^0-9]/g,"");
  if(d.length===4){
    return (parseInt(d.slice(0,2),10)||0)*60 + (parseInt(d.slice(2),10)||0);
  }
  return 0;
}
function fmtMins(m){
  if(!m || m<=0) return "0:00";
  const h = Math.floor(m/60);
  const mm = m%60;
  return h + ":" + (mm<10?"0":"") + mm;
}
function parseHHMM(s){
  s = String(s||"").trim().replace(":","");
  if(s.length===3) s = "0"+s;
  if(s.length!==4) return null;
  const h = parseInt(s.slice(0,2),10);
  const m = parseInt(s.slice(2),10);
  if(Number.isNaN(h)||Number.isNaN(m)||h>23||m>59) return null;
  return h*60+m;
}
function calcBlock(outHHMM, inHHMM){
  const o = parseHHMM(outHHMM);
  const i0 = parseHHMM(inHHMM);
  if(o===null || i0===null) return null;
  let i=i0;
  if(i<o) i += 1440;
  return i-o;
}
function up(s){ return (s||"").toUpperCase(); }

function isTimeHM(s){
  return /^\d+:\d{2}$/.test(String(s||"").trim());
}
function normalizeHM(v){
  const s = String(v||"").trim();
  if(!s) return "";
  if(s.includes(":")){
    const parts = s.split(":");
    const hh = parseInt(parts[0],10);
    const mm = parseInt(parts[1],10);
    if(Number.isNaN(hh) || Number.isNaN(mm) || mm>59) return up(s);
    return String(hh) + ":" + (mm<10?"0":"") + String(mm);
  }
  const d = s.replace(/[^0-9]/g,"");
  if(d.length===4){
    const hh = parseInt(d.slice(0,2),10);
    const mm = parseInt(d.slice(2),10);
    if(mm>59) return "";
    return String(hh) + ":" + (mm<10?"0":"") + String(mm);
  }
  if(d.length===3){
    const hh = parseInt(d.slice(0,1),10);
    const mm = parseInt(d.slice(1),10);
    if(mm>59) return "";
    return String(hh) + ":" + (mm<10?"0":"") + String(mm);
  }
  return up(s);
}

const TIME_KEYS = ["total","night","ifr","pic","cop","dual","fi","simTotal"];
const PREV_TIME_KEYS = ["total","night","ifr","pic","cop","dual","fi","fstd"];

/* =========================
   Previous totals UI (includes FSTD total)
   ========================= */
const prevFields = [
  ["total","TOTAL FLIGHT"],
  ["night","NIGHT"],
  ["ifr","IFR"],
  ["pic","PIC"],
  ["cop","CO-PILOT"],
  ["dual","DUAL"],
  ["fi","FI"],
  ["fstd","FSTD TOTAL"],
  ["ldg_day","DAY LDG"],
  ["ldg_night","NIGHT LDG"]
];

function renderPrev(){
  const grid = document.getElementById("prevGrid");
  grid.innerHTML = "";

  prevFields.forEach(([k,label])=>{
    const d = document.createElement("div");
    d.className="field";
    const ph = k.includes("ldg") ? "0" : "H:MM";
    d.innerHTML = '<label>'+label+'</label><input id="prev_'+k+'" value="'+escapeHTML(prev[k]??"")+'" placeholder="'+ph+'">';
    grid.appendChild(d);

    const el = d.querySelector("input");

    el.addEventListener("input", ()=>{
      if(!k.includes("ldg")) el.value = up(el.value);
      prev[k] = el.value;
      saveJSON(KEY_PREV, prev);
      render();
    });

    el.addEventListener("blur", ()=>{
      if(!k.includes("ldg")) el.value = up(el.value);
      if(PREV_TIME_KEYS.includes(k)){
        const norm = normalizeHM(el.value);
        if(norm) el.value = norm;
        if(isTimeHM(el.value)) _lastTimeValue = el.value;
        prev[k] = el.value;
        saveJSON(KEY_PREV, prev);
        render();
      }
    });
  });
}

/* =========================
   Table cell helper (TAB copies previous time)
   ========================= */
function cellInput(idx, key, val, ph, cls){
  const c = ("cell " + (cls||"")).trim();
  const v = (val===undefined || val===null) ? "" : String(val);
  return '<input class="'+c+'" value="'+escapeHTML(v)+'" placeholder="'+escapeHTML(ph||"")+'" '+
    'oninput="onCell('+idx+', \''+key+'\', this.value)" '+
    'onblur="onCellBlur('+idx+', \''+key+'\', this)" '+
    'onkeydown="onCellKeyDown(event, '+idx+', \''+key+'\', this)">';
}

function ensureRowObject(i){
  if (flights[i]) return;
  flights[i] = {
    id: Date.now() + Math.floor(Math.random()*100000),
    date:"", depPlace:"", out:"", arrPlace:"", in:"",
    acType:"", acReg:"", name:"SELF",
    total:"",
    ldgDay:"0", ldgNight:"0",
    night:"", ifr:"", pic:"", cop:"", dual:"", fi:"",
    simDate:"", simType:"", simTotal:"",
    remarks:""
  };
}

function onCell(i, key, value){
  ensureRowObject(i);
  const f = flights[i];

  f[key] = up(value);

  if(key==="out" || key==="in"){
    const digits = String(f[key]||"").replace(/[^0-9]/g,"");
    if(digits) f[key] = digits;
  }

  if(key==="out" || key==="in"){
    const block = calcBlock(f.out, f.in);
    if(block!==null){
      const blockStr = fmtMins(block);
      if(!f.total) f.total = blockStr;
      if(!f.ifr) f.ifr = blockStr;
      if(!f.pic) f.pic = blockStr;
    }
  }

  saveJSON(KEY_FLIGHTS, flights);
  render();
}

function onCellBlur(i, key, el){
  el.value = up(el.value);

  if(TIME_KEYS.includes(key)){
    const norm = normalizeHM(el.value);
    if(norm) el.value = norm;
    if(isTimeHM(el.value)) _lastTimeValue = el.value;
  }

  if(key==="out" || key==="in"){
    const digits = String(el.value||"").replace(/[^0-9]/g,"");
    el.value = digits;
  }

  onCell(i, key, el.value);
}

function onCellKeyDown(e, i, key, el){
  if(e.key !== "Tab") return;
  const empty = !String(el.value||"").trim();
  if(empty && TIME_KEYS.includes(key) && isTimeHM(_lastTimeValue)){
    el.value = _lastTimeValue;
    onCell(i, key, el.value);
  }
}

function clearRow(index){
  if(!confirm("CLEAR THIS ROW?")) return;
  flights[index] = null;
  saveJSON(KEY_FLIGHTS, flights);
  render();
}

/* =========================
   Render (10 rows per page)
   + Adds FSTD totals in footer rows
   ========================= */
function render(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  const start = (currentPage - 1) * ROWS_PER_PAGE;
  const end = start + ROWS_PER_PAGE;

  if (flights.length < end) {
    for (let i = flights.length; i < end; i++) flights.push(null);
    saveJSON(KEY_FLIGHTS, flights);
  }

  let sum = {
    total:0,
    ldgDay:0, ldgNight:0,
    night:0, ifr:0, pic:0, cop:0, dual:0, fi:0,
    fstd:0
  };

  for(let r=0; r<ROWS_PER_PAGE; r++){
    const idx = start + r;
    const f = flights[idx];

    if(f){
      sum.total += toMins(f.total);
      sum.ldgDay += (parseInt(f.ldgDay,10)||0);
      sum.ldgNight += (parseInt(f.ldgNight,10)||0);
      sum.night += toMins(f.night);
      sum.ifr += toMins(f.ifr);
      sum.pic += toMins(f.pic);
      sum.cop += toMins(f.cop);
      sum.dual += toMins(f.dual);
      sum.fi += toMins(f.fi);
      sum.fstd += toMins(f.simTotal);
    }

    const v = (key) => (f && f[key]) ? f[key] : "";
    const tr = document.createElement("tr");

    tr.innerHTML =
      '<td>'+cellInput(idx,"date", v("date"), "DD.MM.YY", "")+'</td>'+
      '<td>'+cellInput(idx,"depPlace", v("depPlace"), "ICAO", "upper")+'</td>'+
      '<td>'+cellInput(idx,"out", v("out"), "HHMM", "time")+'</td>'+
      '<td>'+cellInput(idx,"arrPlace", v("arrPlace"), "ICAO", "upper")+'</td>'+
      '<td>'+cellInput(idx,"in", v("in"), "HHMM", "time")+'</td>'+
      '<td>'+cellInput(idx,"acType", v("acType"), "B781", "upper")+'</td>'+
      '<td>'+cellInput(idx,"acReg", v("acReg"), "B-17806", "upper")+'</td>'+
      '<td>'+cellInput(idx,"name", v("name"), "SELF", "upper")+'</td>'+

      '<td>'+cellInput(idx,"total", v("total"), "H:MM", "")+'</td>'+
      '<td>'+cellInput(idx,"ldgDay", v("ldgDay"), "0", "small")+'</td>'+
      '<td>'+cellInput(idx,"ldgNight", v("ldgNight"), "0", "small")+'</td>'+

      '<td>'+cellInput(idx,"night", v("night"), "H:MM", "")+'</td>'+
      '<td>'+cellInput(idx,"ifr", v("ifr"), "H:MM", "")+'</td>'+

      '<td>'+cellInput(idx,"pic", v("pic"), "H:MM", "")+'</td>'+
      '<td>'+cellInput(idx,"cop", v("cop"), "H:MM", "")+'</td>'+
      '<td>'+cellInput(idx,"dual", v("dual"), "H:MM", "")+'</td>'+
      '<td>'+cellInput(idx,"fi", v("fi"), "H:MM", "")+'</td>'+

      '<td>'+cellInput(idx,"simDate", v("simDate"), "DD.MM.YY", "small")+'</td>'+
      '<td>'+cellInput(idx,"simType", v("simType"), "TYPE", "small upper")+'</td>'+
      '<td>'+cellInput(idx,"simTotal", v("simTotal"), "H:MM", "small")+'</td>'+

      '<td>'+cellInput(idx,"remarks", v("remarks"), "", "")+'</td>'+
      '<td>'+(f ? '<button class="del" onclick="clearRow('+idx+')">Ã—</button>' : '')+'</td>';

    tbody.appendChild(tr);
  }

  /* previous totals */
  const p = {
    total: toMins(prev.total),
    night: toMins(prev.night),
    ifr: toMins(prev.ifr),
    pic: toMins(prev.pic),
    cop: toMins(prev.cop),
    dual: toMins(prev.dual),
    fi: toMins(prev.fi),
    ldgDay: parseInt(prev.ldg_day,10)||0,
    ldgNight: parseInt(prev.ldg_night,10)||0,
    fstd: toMins(prev.fstd)
  };

  const grand = {
    total: sum.total + p.total,
    night: sum.night + p.night,
    ifr: sum.ifr + p.ifr,
    pic: sum.pic + p.pic,
    cop: sum.cop + p.cop,
    dual: sum.dual + p.dual,
    fi: sum.fi + p.fi,
    ldgDay: sum.ldgDay + p.ldgDay,
    ldgNight: sum.ldgNight + p.ldgNight,
    fstd: sum.fstd + p.fstd
  };

  document.getElementById("k_total").textContent = fmtMins(grand.total);
  document.getElementById("k_pic").textContent   = fmtMins(grand.pic);
  document.getElementById("k_night").textContent = fmtMins(grand.night);
  document.getElementById("k_ifr").textContent   = fmtMins(grand.ifr);

  const maxPage = Math.max(1, Math.ceil(flights.length / ROWS_PER_PAGE));
  if(currentPage > maxPage) currentPage = maxPage;
  document.getElementById("pageLabel").textContent = "PAGE " + currentPage + " / " + maxPage;

  /* Footer rows */
  document.getElementById("tfoot").innerHTML =
    '<tr class="total-this">'+
      '<td class="tfLabel" colspan="8">TOTAL FROM THIS PAGE</td>'+
      '<td>'+(sum.total?fmtMins(sum.total):"â€”")+'</td>'+
      '<td>'+(sum.ldgDay||"â€”")+'</td>'+
      '<td>'+(sum.ldgNight||"â€”")+'</td>'+
      '<td>'+(sum.night?fmtMins(sum.night):"â€”")+'</td>'+
      '<td>'+(sum.ifr?fmtMins(sum.ifr):"â€”")+'</td>'+
      '<td>'+(sum.pic?fmtMins(sum.pic):"â€”")+'</td>'+
      '<td>'+(sum.cop?fmtMins(sum.cop):"â€”")+'</td>'+
      '<td>'+(sum.dual?fmtMins(sum.dual):"â€”")+'</td>'+
      '<td>'+(sum.fi?fmtMins(sum.fi):"â€”")+'</td>'+
      '<td colspan="2">â€”</td>'+
      '<td>'+(sum.fstd?fmtMins(sum.fstd):"â€”")+'</td>'+
      '<td></td>'+
      '<td></td>'+
    '</tr>'+

    '<tr class="total-prev">'+
      '<td class="tfLabel" colspan="8">TOTAL FROM PREVIOUS PAGE</td>'+
      '<td>'+(p.total?fmtMins(p.total):"â€”")+'</td>'+
      '<td>'+(p.ldgDay||"â€”")+'</td>'+
      '<td>'+(p.ldgNight||"â€”")+'</td>'+
      '<td>'+(p.night?fmtMins(p.night):"â€”")+'</td>'+
      '<td>'+(p.ifr?fmtMins(p.ifr):"â€”")+'</td>'+
      '<td>'+(p.pic?fmtMins(p.pic):"â€”")+'</td>'+
      '<td>'+(p.cop?fmtMins(p.cop):"â€”")+'</td>'+
      '<td>'+(p.dual?fmtMins(p.dual):"â€”")+'</td>'+
      '<td>'+(p.fi?fmtMins(p.fi):"â€”")+'</td>'+
      '<td colspan="2">â€”</td>'+
      '<td>'+(p.fstd?fmtMins(p.fstd):"â€”")+'</td>'+
      '<td></td>'+
      '<td></td>'+
    '</tr>'+

    '<tr class="grand">'+
      '<td class="tfLabel" colspan="8">â–  TOTAL TO DATE</td>'+
      '<td>'+(grand.total?fmtMins(grand.total):"â€”")+'</td>'+
      '<td>'+(grand.ldgDay||"â€”")+'</td>'+
      '<td>'+(grand.ldgNight||"â€”")+'</td>'+
      '<td>'+(grand.night?fmtMins(grand.night):"â€”")+'</td>'+
      '<td>'+(grand.ifr?fmtMins(grand.ifr):"â€”")+'</td>'+
      '<td>'+(grand.pic?fmtMins(grand.pic):"â€”")+'</td>'+
      '<td>'+(grand.cop?fmtMins(grand.cop):"â€”")+'</td>'+
      '<td>'+(grand.dual?fmtMins(grand.dual):"â€”")+'</td>'+
      '<td>'+(grand.fi?fmtMins(grand.fi):"â€”")+'</td>'+
      '<td colspan="2">â€”</td>'+
      '<td>'+(grand.fstd?fmtMins(grand.fstd):"â€”")+'</td>'+
      '<td></td>'+
      '<td></td>'+
    '</tr>';

  saveJSON(KEY_FLIGHTS, flights);
}

/* =========================
   Modal behavior
   ========================= */
function openModal(){ document.getElementById("overlay").classList.add("open"); renderAttachPreview(); }
function closeModal(){ document.getElementById("overlay").classList.remove("open"); }
function overlayClick(e){ if(e.target && e.target.id==="overlay") closeModal(); }

/* =========================
   Add flight (first empty row on current page, else next page)
   ========================= */
function saveFromModal(){
  const get = id => up(document.getElementById(id).value.trim());

  const out = String(get("f_out")).replace(/[^0-9]/g,"");
  const inn = String(get("f_in")).replace(/[^0-9]/g,"");
  const block = calcBlock(out, inn);
  const blockStr = block!==null ? fmtMins(block) : "";

  const total = normalizeHM(get("f_total")) || blockStr;
  const ifr   = normalizeHM(get("f_ifr")) || total;
  const pic   = normalizeHM(get("f_pic")) || total;

  const row = {
    id: Date.now() + Math.floor(Math.random()*100000),
    date: get("f_date"),
    depPlace: get("f_dep"),
    out: out,
    arrPlace: get("f_arr"),
    in: inn,
    acType: get("f_type"),
    acReg: get("f_reg"),
    name: get("f_name") || "SELF",

    total: total,
    ldgDay: String(document.getElementById("f_ldg_day").value || "0").trim(),
    ldgNight: String(document.getElementById("f_ldg_night").value || "0").trim(),

    night: normalizeHM(get("f_night")),
    ifr: ifr,

    pic: pic,
    cop: normalizeHM(get("f_cop")),
    dual: normalizeHM(get("f_dual")),
    fi: normalizeHM(get("f_fi")),

    simDate: get("f_sim_date"),
    simType: get("f_sim_type"),
    simTotal: normalizeHM(get("f_sim_total")),

    remarks: get("f_rem")
  };

  const start = (currentPage - 1) * ROWS_PER_PAGE;
  const end = start + ROWS_PER_PAGE;

  if (flights.length < end) for (let i = flights.length; i < end; i++) flights.push(null);

  let placed = false;
  for(let i=start; i<end; i++){
    if(!flights[i]){
      flights[i] = row;
      placed = true;
      break;
    }
  }

  if(!placed){
    setPage(currentPage + 1);
    const newStart = (currentPage - 1) * ROWS_PER_PAGE;
    const newEnd = newStart + ROWS_PER_PAGE;
    if (flights.length < newEnd) for (let i = flights.length; i < newEnd; i++) flights.push(null);
    flights[newStart] = row;
  }

  if(isTimeHM(row.total)) _lastTimeValue = row.total;
  if(isTimeHM(row.simTotal)) _lastTimeValue = row.simTotal;

  saveJSON(KEY_FLIGHTS, flights);

  /* CLEAR MODAL */
  document.querySelectorAll(".modal input").forEach(i=>i.value="");
  attach = { photoDataUrl:"", pdfName:"" };
  saveJSON(KEY_ATTACH, attach);
  renderAttachPreview();

  closeModal();
  render();

  setTimeout(focusFirstEmptyRow, 80);
}
/* =========================
   Attachments (local preview only)
   ========================= */
document.getElementById("photoInput").addEventListener("change", (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = ()=>{
    attach.photoDataUrl = String(r.result || "");
    saveJSON(KEY_ATTACH, attach);
    renderAttachPreview();
  };
  r.readAsDataURL(file);
});
document.getElementById("pdfInput").addEventListener("change", (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  attach.pdfName = up(file.name || "LOGBOOK.PDF");
  saveJSON(KEY_ATTACH, attach);
  renderAttachPreview();
});
function renderAttachPreview(){
  const p = document.getElementById("photoPrev");
  if(attach.photoDataUrl){
    p.style.display = "block";
    p.innerHTML = '<img src="'+attach.photoDataUrl+'" alt="PHOTO PREVIEW">';
  }else{
    p.style.display = "none";
    p.innerHTML = "";
  }
  document.getElementById("pdfName").textContent = attach.pdfName ? ("SELECTED PDF: " + attach.pdfName) : "";
}

/* =========================
   Backup / Restore / Reset
   ========================= */
function exportBackup(){
  const payload = {
    flights,
    prev,
    theme: document.body.classList.contains("light") ? "light" : "dark",
    page: currentPage
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "MARA-LOGBOOK-BACKUP.JSON";
  a.click();
}
function importBackup(){
  const input = document.createElement("input");
  input.type="file";
  input.accept=".json,application/json";
  input.onchange = ()=>{
    const file = input.files && input.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const obj = JSON.parse(String(r.result||"{}"));
        if(Array.isArray(obj.flights)) flights = obj.flights;
        if(obj.prev) prev = obj.prev;

        saveJSON(KEY_FLIGHTS, flights);
        saveJSON(KEY_PREV, prev);

        applyTheme(obj.theme === "light" ? "light" : "dark");
        currentPage = parseInt(obj.page || "1", 10) || 1;
        localStorage.setItem(KEY_PAGE, String(currentPage));

        renderPrev();
        render();
      }catch(e){
        alert("BACKUP FILE NOT VALID.");
      }
    };
    r.readAsText(file);
  };
  input.click();
}
function resetAll(){
  if(!confirm("RESET ALL DATA (FLIGHTS + TOTALS + ATTACHMENTS)?")) return;

  localStorage.removeItem(KEY_FLIGHTS);
  localStorage.removeItem(KEY_PREV);
  localStorage.removeItem(KEY_ATTACH);
  localStorage.removeItem(KEY_PAGE);

  flights = [];
  prev = {
    total:"0:00", night:"0:00", ifr:"0:00",
    pic:"0:00", cop:"0:00", dual:"0:00", fi:"",
    fstd:"0:00",
    ldg_day:"0", ldg_night:"0"
  };
  attach = { photoDataUrl:"", pdfName:"" };
  currentPage = 1;

  saveJSON(KEY_FLIGHTS, flights);
  saveJSON(KEY_PREV, prev);
  saveJSON(KEY_ATTACH, attach);
  localStorage.setItem(KEY_PAGE, "1");

  renderPrev();
  render();
}

/* =========================
   Import sample 10 flights (photo page)
   ========================= */
function seedFromPhoto(){
  if(!confirm("IMPORT THE 10 FLIGHTS FROM YOUR LOGBOOK PHOTO PAGE INTO PAGE 1?")) return;

  const seeded = [
    {date:"23.11", depPlace:"RCTP", out:"1300", arrPlace:"VTBS", in:"1642", acType:"B781", acReg:"B-17812", name:"SELF", total:"3:42", night:"3:42", ifr:"3:42", pic:"3:42", ldgDay:"0", ldgNight:"0"},
    {date:"24.11", depPlace:"VTBS", out:"1957", arrPlace:"RCTP", in:"2329", acType:"B781", acReg:"B-17810", name:"SELF", total:"3:32", night:"2:32", ifr:"3:32", pic:"3:32", ldgDay:"1", ldgNight:"0"},
    {date:"26.11", depPlace:"RCTP", out:"0735", arrPlace:"RKSI", in:"0957", acType:"B789", acReg:"B-17883", name:"SELF", total:"2:22", night:"2:22", ifr:"2:22", pic:"2:22", ldgDay:"0", ldgNight:"1"},
    {date:"26.11", depPlace:"RKSI", out:"1114", arrPlace:"RCTP", in:"1415", acType:"B789", acReg:"B-17883", name:"SELF", total:"3:01", night:"",    ifr:"3:01", pic:"3:01", ldgDay:"0", ldgNight:"0"},
    {date:"01.12", depPlace:"RCTP", out:"0732", arrPlace:"RKSI", in:"0951", acType:"B781", acReg:"B-17815", name:"SELF", total:"2:19", night:"1:19", ifr:"2:19", pic:"2:19", ldgDay:"0", ldgNight:"1"},
    {date:"01.12", depPlace:"RKSI", out:"1059", arrPlace:"RCTP", in:"1338", acType:"B781", acReg:"B-17815", name:"SELF", total:"2:38", night:"2:38", ifr:"2:38", pic:"2:38", ldgDay:"0", ldgNight:"0"},
    {date:"04.12", depPlace:"VTBS", out:"1945", arrPlace:"LOWW", in:"0649", acType:"B781", acReg:"B-17883", name:"SELF", total:"11:25",night:"7:00", ifr:"11:25",pic:"11:25",ldgDay:"1",ldgNight:"0"},
    {date:"07.12", depPlace:"LOWW", out:"1657", arrPlace:"VTBS", in:"0308", acType:"B781", acReg:"B-17883", name:"SELF", total:"10:11",night:"7:30", ifr:"10:11",pic:"10:11",ldgDay:"0",ldgNight:"0"},
    {date:"12.12", depPlace:"WSSS", out:"1924", arrPlace:"RCTP", in:"2359", acType:"B789", acReg:"B-17887", name:"SELF", total:"4:25", night:"9:25", ifr:"4:25", pic:"4:25", ldgDay:"0", ldgNight:"1"},
    {date:"17.12", depPlace:"RCTP", out:"1153", arrPlace:"KDFW", in:"0112", acType:"B789", acReg:"B-17886", name:"SELF", total:"14:19",night:"5:00", ifr:"14:19",pic:"14:19",ldgDay:"0",ldgNight:"0"}
  ];

  flights = [];
  for(let i=0;i<ROWS_PER_PAGE;i++) flights.push(null);

  for(let i=0;i<seeded.length;i++){
    const x = seeded[i];
    flights[i] = {
      id: Date.now() + Math.floor(Math.random()*100000),
      date: up(x.date),
      depPlace: up(x.depPlace),
      out: String(x.out).replace(/[^0-9]/g,""),
      arrPlace: up(x.arrPlace),
      in: String(x.in).replace(/[^0-9]/g,""),
      acType: up(x.acType),
      acReg: up(x.acReg),
      name: up(x.name),

      total: up(x.total),
      ldgDay: String(x.ldgDay),
      ldgNight: String(x.ldgNight),

      night: up(x.night),
      ifr: up(x.ifr),
      pic: up(x.pic),
      cop: "",
      dual: "",
      fi: "",

      simDate: "",
      simType: "",
      simTotal: "",

      remarks: ""
    };
  }

  currentPage = 1;
  localStorage.setItem(KEY_PAGE, "1");
  saveJSON(KEY_FLIGHTS, flights);

  _lastTimeValue = isTimeHM(flights[0]?.total) ? flights[0].total : _lastTimeValue;
  render();
}
function focusFirstEmptyRow(){
  const start = (currentPage - 1) * ROWS_PER_PAGE;
  const end = start + ROWS_PER_PAGE;

  for(let i=start; i<end; i++){
    if(!flights[i]){
      const rowIndex = i - start;
      const tbody = document.getElementById("tbody");
      const row = tbody.children[rowIndex];
      if(row){
        const firstInput = row.querySelector("input");
        if(firstInput){
          firstInput.focus();
          return;
        }
      }
    }
  }
}
/* =========================
   Escaping
   ========================= */
function escapeHTML(s){
  return String(s||"").replace(/[&<>"']/g, function(m){
    return ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m] || m);
  });
}

/* =========================
   Init
   ========================= */
applyTheme(localStorage.getItem(KEY_THEME) || "dark");
renderPrev();
render();
</script
  <div class="print-footer-easa">
  PILOT: MARIO MARIC | LICENCE NO: HR.FCL.A.0059
</div>

</body>
</html>
