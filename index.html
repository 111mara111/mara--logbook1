<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mara Pilot Logbook</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0b1a33">

  <!-- iOS Home Screen -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Mara Logbook">
  <!-- Use ONE apple-touch-icon (iOS picks best size it can) -->
  <link rel="apple-touch-icon" href="./icon-192.png">

  <style>
    /* =========================
       Mara Logbook UI (Dark/Light)
       Fixed 10 rows per page
       ========================= */

    :root{
      --bg: #071326;
      --panel: rgba(10, 24, 50, 0.72);
      --panel2: rgba(10, 24, 50, 0.55);
      --ink: #eaf0ff;
      --muted: rgba(234,240,255,.70);
      --line: rgba(234,240,255,.10);
      --line2: rgba(234,240,255,.06);

      --blue1: #0b1a33;
      --blue2: #0a254a;
      --blue3: #0d2f5e;

      --gold: #d9bb62;
      --gold2:#caa84a;

      --danger: #d06b5f;
      --ok: #59c18d;

      --thead: rgba(8, 20, 45, .72);
      --row: rgba(255,255,255,.02);
      --rowAlt: rgba(255,255,255,.035);
      --rowHover: rgba(217,187,98,.08);

      --shadow: 0 24px 80px rgba(0,0,0,.35);
    }

    body.light{
      --bg: #eef3ff;
      --panel: rgba(255,255,255,.82);
      --panel2: rgba(255,255,255,.72);
      --ink: #0b1a33;
      --muted: rgba(11,26,51,.65);
      --line: rgba(11,26,51,.12);
      --line2: rgba(11,26,51,.06);

      --blue1: #ffffff;
      --blue2: #f3f7ff;
      --blue3: #eaf1ff;

      --thead: rgba(234,241,255,.9);
      --row: rgba(255,255,255,.9);
      --rowAlt: rgba(245,248,255,.95);
      --rowHover: rgba(217,187,98,.12);

      --shadow: 0 24px 70px rgba(10,25,60,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 15%, rgba(14,60,120,.25), transparent 55%),
                  radial-gradient(1000px 550px at 80% 20%, rgba(30,80,170,.18), transparent 58%),
                  radial-gradient(900px 700px at 60% 80%, rgba(0,0,0,.35), transparent 60%),
                  var(--bg);
      color: var(--ink);
      overflow-x:hidden;
    }

    .app{
      max-width: 1500px;
      margin: 0 auto;
      padding: 18px 14px 30px;
    }

    /* ===== Header ===== */
    .topbar{
      position: sticky;
      top: 10px;
      z-index: 50;

      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;

      border:1px solid var(--line2);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      backdrop-filter: blur(12px);

      border-radius: 16px;
      padding: 14px 14px;
      box-shadow: var(--shadow);
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 250px;
    }
    .brand .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 900;
      letter-spacing: 4px;
      text-transform: uppercase;
      white-space: nowrap;
      font-size: 20px;
    }
    .brand .sub{
      font-size: 10px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .kpis{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      flex:1;
      flex-wrap:wrap;
      min-width: 320px;
    }
    .kpi{
      min-width: 150px;
      text-align:center;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line2);
    }
    .kpi .v{
      font-weight: 900;
      font-size: 22px;
      letter-spacing: 1px;
      color: var(--gold);
      font-variant-numeric: tabular-nums;
    }
    .kpi .l{
      margin-top: 3px;
      font-size: 10px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--ink);
      padding: 10px 14px;
      font-weight: 900;
      font-size: 12px;
      letter-spacing: 1px;
      cursor:pointer;
      transition: transform .12s, background .12s, border-color .12s, opacity .12s;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(217,187,98,.35); }
    .btn:active{ transform: translateY(0px); opacity: .9; }

    .btn.gold{
      background: linear-gradient(180deg, var(--gold), var(--gold2));
      color: #1b1b1b;
      border-color: rgba(0,0,0,0);
    }
    .btn.gold:hover{ border-color: rgba(0,0,0,0); }

    .btn.danger{
      background: rgba(208,107,95,.12);
      border-color: rgba(208,107,95,.30);
      color: var(--danger);
    }

    .btn.ok{
      background: rgba(89,193,141,.12);
      border-color: rgba(89,193,141,.30);
      color: var(--ok);
    }

    .btn.small{
      padding: 9px 12px;
      font-size: 12px;
      min-width: 44px;
    }

    /* ===== Panels ===== */
    .panel{
      margin-top: 14px;
      border-radius: 16px;
      overflow: hidden;
      border:1px solid var(--line2);
      background: var(--panel);
      box-shadow: var(--shadow);
    }
    .panel-h{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      border-bottom:1px solid var(--line2);
      gap:10px;
      flex-wrap:wrap;
    }
    .panel-h .left{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 900;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .panel-h .right{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* ===== Previous totals fields ===== */
    .prev-grid{
      padding: 14px;
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size: 10px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 900;
    }
    .field input{
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.02);
      color: var(--ink);
      padding: 10px 12px;
      font-weight: 900;
      outline: none;
      font-variant-numeric: tabular-nums;
    }
    body.light .field input{ background: rgba(255,255,255,.8); }
    .field input:focus{ border-color: rgba(217,187,98,.45); }

    /* ===== Table ===== */
    .table-wrap{
      width:100%;
      overflow:auto;
      background: var(--panel2);
    }
    table{
      width: 100%;
      min-width: 1500px;
      border-collapse: collapse;
      font-size: 11px;
      font-variant-numeric: tabular-nums;
    }
    th, td{
      border: 1px solid var(--line2);
      padding: 8px 6px;
      text-align:center;
      vertical-align: middle;
      white-space: nowrap;
    }
    thead th{
      background: var(--thead);
      color: var(--muted);
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-size: 10px;
    }
    tbody tr{ background: var(--row); }
    tbody tr:nth-child(even){ background: var(--rowAlt); }
    tbody tr:hover{ background: var(--rowHover); }

    .cell{
      width: 100%;
      border: none;
      outline: none;
      background: transparent;
      color: var(--ink);
      font-weight: 900;
      text-align: center;
      font-size: 11px;
      padding: 2px 0;
    }
    .cell::placeholder{ color: rgba(160,180,220,.55); font-weight: 800; }
    body.light .cell::placeholder{ color: rgba(90,110,150,.55); }

    .upper{ text-transform: uppercase; letter-spacing: 1px; }
    .time{ letter-spacing: 1px; }
    .small{ font-size: 10px; }

    .cell:focus{
      background: rgba(217,187,98,.10);
      border-radius: 8px;
    }

    tfoot td{
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-weight: 900;
    }
    .tfLabel{
      text-align:left;
      padding-left: 10px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
      font-size: 10px;
    }
    .grand td{
      border-top: 2px solid rgba(217,187,98,.25);
      background: rgba(217,187,98,.10);
      color: var(--gold);
      font-size: 12px;
    }

    .del{
      border-radius: 10px;
      border: 1px solid rgba(208,107,95,.35);
      background: rgba(208,107,95,.12);
      color: var(--danger);
      cursor:pointer;
      font-weight: 900;
      padding: 6px 10px;
    }

    /* ===== Modal ===== */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 100;
      backdrop-filter: blur(12px);
    }
    .overlay.open{ display:flex; }

    .modal{
      width: min(980px, 100%);
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid var(--line2);
      background: var(--panel);
      box-shadow: var(--shadow);
    }
    .modal-h{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--line2);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .modal-h .t{
      font-weight: 900;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .modal-b{
      padding: 14px 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .hint{
      grid-column: 1 / -1;
      border: 1px dashed var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      background: rgba(255,255,255,.03);
    }

    .scanRow{
      grid-column: 1 / -1;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .scanBtn{
      flex:1;
      min-width: 280px;
      border-radius: 16px;
      padding: 14px 14px;
      border: 2px dashed rgba(118,169,255,.35);
      background: rgba(118,169,255,.08);
      color: var(--ink);
      font-weight: 900;
      letter-spacing: 2px;
      text-transform: uppercase;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .scanBtn.pdf{
      border-color: rgba(89,193,141,.35);
      background: rgba(89,193,141,.08);
    }
    .fileHidden{ display:none; }

    .preview{
      grid-column: 1 / -1;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid var(--line2);
      background: rgba(0,0,0,.08);
      display:none;
      max-height: 240px;
    }
    .preview img{ width:100%; display:block; }

    .modal-actions{
      grid-column: 1 / -1;
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top: 6px;
      flex-wrap:wrap;
    }

    @media (max-width: 1100px){
      .kpis{ display:none; }
    }
    @media (max-width: 980px){
      .prev-grid{ grid-template-columns: 1fr 1fr; }
      .modal-b{ grid-template-columns: 1fr; }
      table{ min-width: 1250px; }
    }

    @media print{
      .topbar, .panel-h .right, .del, .overlay { display:none !important; }
      body{ background:#fff; }
      .panel{ box-shadow:none; background:#fff; }
      @page{ size: A4 landscape; margin: 10mm; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- Service worker registration -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
      }
    </script>

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="brand">
        <div class="title">‚úà MARA PILOT LOGBOOK</div>
        <div class="sub">Flight Record System</div>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="v" id="k_total">0:00</div><div class="l">Total Time</div></div>
        <div class="kpi"><div class="v" id="k_pic">0:00</div><div class="l">PIC Time</div></div>
        <div class="kpi"><div class="v" id="k_night">0:00</div><div class="l">Night</div></div>
        <div class="kpi"><div class="v" id="k_ifr">0:00</div><div class="l">IFR Actual</div></div>
      </div>

      <div class="actions">
        <button class="btn small" onclick="setPage(currentPage-1)">‚óÄ</button>
        <button class="btn" id="pageLabel" style="min-width:130px">PAGE 1 / 1</button>
        <button class="btn small" onclick="setPage(currentPage+1)">‚ñ∂</button>

        <button class="btn" id="themeBtn" onclick="toggleTheme()">LIGHT</button>
        <button class="btn gold" onclick="openModal()">+ ADD FLIGHT</button>
      </div>
    </div>

    <!-- TOTAL FROM PREVIOUS PAGE -->
    <div class="panel">
      <div class="panel-h">
        <div class="left">üìã TOTAL FROM PREVIOUS PAGE</div>
        <div class="right">
          <button class="btn ok" onclick="seedFromPhoto()">IMPORT (PHOTO PAGE)</button>
          <button class="btn" onclick="exportBackup()">BACKUP</button>
          <button class="btn" onclick="importBackup()">RESTORE</button>
          <button class="btn" onclick="window.print()">EXPORT PDF</button>
          <button class="btn danger" onclick="resetAll()">RESET</button>
        </div>
      </div>

      <div class="prev-grid" id="prevGrid"></div>
    </div>

    <!-- LOGBOOK TABLE -->
    <div class="panel">
      <div class="panel-h">
        <div class="left">üìò LOGBOOK PAGE (10 ROWS)</div>
        <div class="right">
          <span style="color:var(--muted);font-weight:900;font-size:12px;letter-spacing:1px;">
            Auto-saved locally ‚Ä¢ Works offline
          </span>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>DATE<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">DD.MM.YY</span></th>

              <th>DEP<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">PLACE</span></th>
              <th>DEP<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">TIME</span></th>

              <th>ARR<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">PLACE</span></th>
              <th>ARR<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">TIME</span></th>

              <th>AIRCRAFT<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">TYPE</span></th>
              <th>AIRCRAFT<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">REG</span></th>

              <th>NAME(S)<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">PIC</span></th>

              <th>SE</th>
              <th>ME</th>
              <th>MULTI<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">PILOT</span></th>

              <th>TOTAL<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">FLIGHT</span></th>

              <th>NIGHT</th>
              <th>IFR<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">ACTUAL</span></th>

              <th>PIC</th>
              <th>CO-PILOT</th>
              <th>DUAL</th>
              <th>FI</th>

              <th>DAY<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">LDG</span></th>
              <th>NIGHT<br><span style="font-size:9px;letter-spacing:1px;opacity:.7;">LDG</span></th>

              <th>REMARKS & ENDORSEMENTS</th>
              <th></th>
            </tr>
          </thead>

          <tbody id="tbody"></tbody>
          <tfoot id="tfoot"></tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="overlay" id="overlay" onclick="overlayClick(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-h">
        <div class="t">‚úà NEW FLIGHT ENTRY</div>
        <button class="btn" onclick="closeModal()">Close</button>
      </div>

      <div class="modal-b">
        <div class="scanRow">
          <button class="scanBtn" onclick="document.getElementById('photoInput').click()">
            üì∑ PHOTO SCAN
          </button>
          <button class="scanBtn pdf" onclick="document.getElementById('pdfInput').click()">
            üìÑ PDF IMPORT
          </button>
          <input class="fileHidden" type="file" id="photoInput" accept="image/*">
          <input class="fileHidden" type="file" id="pdfInput" accept="application/pdf">
        </div>

        <div class="hint">
          <b>Note:</b> On GitHub Pages this app works fully offline and saves locally.
          ‚ÄúPhoto/PDF import‚Äù here stores a local preview (no AI extraction on GitHub Pages without a backend).
          Use <b>IMPORT (PHOTO PAGE)</b> to auto-fill the flights from your sample page.
        </div>

        <div class="preview" id="photoPrev"></div>
        <div id="pdfName" style="grid-column:1/-1;color:var(--muted);font-weight:900;letter-spacing:1px;"></div>

        <div class="field"><label>Date (DD.MM.YY)</label><input id="f_date" placeholder="23.11"></div>
        <div class="field"><label>Name(s) PIC</label><input id="f_name" placeholder="SELF"></div>

        <div class="field"><label>Dep Place (ICAO)</label><input id="f_dep" placeholder="RCTP"></div>
        <div class="field"><label>Dep Time (HHMM)</label><input id="f_out" placeholder="1300"></div>

        <div class="field"><label>Arr Place (ICAO)</label><input id="f_arr" placeholder="VTBS"></div>
        <div class="field"><label>Arr Time (HHMM)</label><input id="f_in" placeholder="1642"></div>

        <div class="field"><label>Aircraft Type</label><input id="f_type" placeholder="B781"></div>
        <div class="field"><label>Registration</label><input id="f_reg" placeholder="B-17812"></div>

        <div class="field"><label>SE (H:MM)</label><input id="f_se" placeholder=""></div>
        <div class="field"><label>ME (H:MM)</label><input id="f_me" placeholder=""></div>

        <div class="field"><label>Multi Pilot (H:MM)</label><input id="f_mp" placeholder="auto"></div>
        <div class="field"><label>Total Flight (H:MM)</label><input id="f_total" placeholder="auto"></div>

        <div class="field"><label>Night (H:MM)</label><input id="f_night" placeholder=""></div>
        <div class="field"><label>IFR Actual (H:MM)</label><input id="f_ifr" placeholder="auto"></div>

        <div class="field"><label>PIC (H:MM)</label><input id="f_pic" placeholder="auto"></div>
        <div class="field"><label>Co-Pilot (H:MM)</label><input id="f_cop" placeholder=""></div>

        <div class="field"><label>Dual (H:MM)</label><input id="f_dual" placeholder=""></div>
        <div class="field"><label>FI (H:MM)</label><input id="f_fi" placeholder=""></div>

        <div class="field"><label>LDG Day</label><input id="f_ldg_day" type="number" min="0" placeholder="0"></div>
        <div class="field"><label>LDG Night</label><input id="f_ldg_night" type="number" min="0" placeholder="0"></div>

        <div class="field" style="grid-column:1/-1"><label>Remarks</label><input id="f_rem" placeholder=""></div>

        <div class="modal-actions">
          <button class="btn" onclick="closeModal()">Cancel</button>
          <button class="btn gold" onclick="saveFromModal()">Save Flight</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Storage + State
   ========================= */
const KEY_FLIGHTS = "mara_book_flights_v2";
const KEY_PREV    = "mara_book_prev_v2";
const KEY_THEME   = "mara_book_theme_v2";
const KEY_ATTACH  = "mara_book_attach_v2";

const ROWS_PER_PAGE = 10;
const KEY_PAGE = "mara_page_v1";

let currentPage = parseInt(localStorage.getItem(KEY_PAGE) || "1", 10);
if (!currentPage || currentPage < 1) currentPage = 1;

let flights = loadJSON(KEY_FLIGHTS, []); // we store null placeholders too

let prev = loadJSON(KEY_PREV, {
  mp_me: "0:00",
  total: "0:00",
  night: "0:00",
  ifr: "0:00",
  pic: "0:00",
  cop: "0:00",
  dual: "0:00",
  fi: "",
  ldg_day: "0",
  ldg_night: "0"
});

let attach = loadJSON(KEY_ATTACH, { photoDataUrl: "", pdfName: "" });

function loadJSON(k, fallback){
  try{
    const v = localStorage.getItem(k);
    if(!v) return fallback;
    return JSON.parse(v);
  }catch(e){ return fallback; }
}
function saveJSON(k, v){
  try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){}
}

/* =========================
   Page
   ========================= */
function setPage(p){
  currentPage = Math.max(1, p);
  localStorage.setItem(KEY_PAGE, String(currentPage));
  render();
}

/* =========================
   Theme
   ========================= */
function applyTheme(mode){
  if(mode === "light"){
    document.body.classList.add("light");
    document.getElementById("themeBtn").textContent = "DARK";
  }else{
    document.body.classList.remove("light");
    document.getElementById("themeBtn").textContent = "LIGHT";
  }
  localStorage.setItem(KEY_THEME, mode);
}
function toggleTheme(){
  const isLight = document.body.classList.contains("light");
  applyTheme(isLight ? "dark" : "light");
}

/* =========================
   Time utils
   ========================= */
function toMins(hhmm){
  if(!hhmm) return 0;
  const s = String(hhmm).trim();
  if(!s) return 0;
  if(s.includes(":")){
    const [h,m] = s.split(":");
    return (parseInt(h,10)||0)*60 + (parseInt(m,10)||0);
  }
  const d = s.replace(/[^0-9]/g,"");
  if(d.length===4){
    return (parseInt(d.slice(0,2),10)||0)*60 + (parseInt(d.slice(2),10)||0);
  }
  return 0;
}
function fmtMins(m){
  if(!m || m<=0) return "0:00";
  const h = Math.floor(m/60);
  const mm = m%60;
  return h + ":" + (mm<10?"0":"") + mm;
}
function parseHHMM(s){
  s = String(s||"").trim().replace(":","");
  if(s.length===3) s = "0"+s;
  if(s.length!==4) return null;
  const h = parseInt(s.slice(0,2),10);
  const m = parseInt(s.slice(2),10);
  if(Number.isNaN(h)||Number.isNaN(m)||h>23||m>59) return null;
  return h*60+m;
}
function calcBlock(outHHMM, inHHMM){
  const o = parseHHMM(outHHMM);
  const i0 = parseHHMM(inHHMM);
  if(o===null || i0===null) return null;
  let i=i0;
  if(i<o) i += 1440;
  return i-o;
}
function up(s){ return (s||"").toUpperCase(); }

/* =========================
   Previous totals UI
   ========================= */
const prevFields = [
  ["mp_me","MULTI-PILOT ME"],
  ["total","TOTAL FLIGHT"],
  ["night","NIGHT"],
  ["ifr","IFR ACTUAL"],
  ["pic","PIC"],
  ["cop","CO-PILOT"],
  ["dual","DUAL"],
  ["fi","FI"],
  ["ldg_day","DAY LDG"],
  ["ldg_night","NIGHT LDG"]
];

function renderPrev(){
  const grid = document.getElementById("prevGrid");
  grid.innerHTML = "";
  prevFields.forEach(([k,label])=>{
    const d = document.createElement("div");
    d.className="field";
    d.innerHTML = `<label>${label}</label><input id="prev_${k}" value="${escapeHTML(prev[k]??"")}" placeholder="${k.includes('ldg')?'0':'H:MM'}">`;
    grid.appendChild(d);
    const el = d.querySelector("input");
    el.addEventListener("input", ()=>{
      prev[k] = el.value;
      saveJSON(KEY_PREV, prev);
      render();
    });
  });
}

/* =========================
   Table cell helper
   ========================= */
function cellInput(idx, key, val, ph, cls){
  const c = ["cell", cls||""].join(" ").trim();
  const v = (val===undefined || val===null) ? "" : String(val);
  return `<input class="${c}" value="${escapeHTML(v)}" placeholder="${escapeHTML(ph||"")}"
          oninput="onCell(${idx}, '${key}', this.value)">`;
}

/* =========================
   Editing logic
   ========================= */
function ensureRowObject(i){
  if (flights[i]) return;
  flights[i] = {
    id: Date.now() + Math.floor(Math.random()*100000),
    date:"", depPlace:"", out:"", arrPlace:"", in:"",
    acType:"", acReg:"", name:"SELF",
    se:"", me:"", mp:"", total:"",
    night:"", ifr:"", pic:"", cop:"", dual:"", fi:"",
    ldgDay:"0", ldgNight:"0",
    remarks:""
  };
}

function onCell(i, key, value){
  ensureRowObject(i);
  const f = flights[i];

  f[key] = value;

  if(["depPlace","arrPlace","acType","acReg"].includes(key)){
    f[key] = up(value);
  }

  if(key==="out" || key==="in"){
    const block = calcBlock(f.out, f.in);
    if(block!==null){
      const blockStr = fmtMins(block);

      if(!f.total) f.total = blockStr;
      if(!f.mp) f.mp = blockStr;
      if(!f.me && !f.se) f.me = blockStr;

      if(!f.ifr) f.ifr = blockStr;
      if(!f.pic) f.pic = blockStr;
    }
  }

  saveJSON(KEY_FLIGHTS, flights);
  render();
}

function clearRow(index){
  if(!confirm("Clear this row?")) return;
  flights[index] = null;
  saveJSON(KEY_FLIGHTS, flights);
  render();
}

/* =========================
   Render (10 rows per page)
   ========================= */
function render(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  const start = (currentPage - 1) * ROWS_PER_PAGE;
  const end = start + ROWS_PER_PAGE;

  if (flights.length < end) {
    for (let i = flights.length; i < end; i++) flights.push(null);
    saveJSON(KEY_FLIGHTS, flights);
  }

  // totals for THIS page only
  let sum = {
    se:0, me:0, mp:0, total:0,
    night:0, ifr:0, pic:0, cop:0, dual:0, fi:0,
    ldgDay:0, ldgNight:0
  };

  for(let r=0; r<ROWS_PER_PAGE; r++){
    const idx = start + r;
    const f = flights[idx];

    if(f){
      sum.se += toMins(f.se);
      sum.me += toMins(f.me);
      sum.mp += toMins(f.mp);
      sum.total += toMins(f.total);
      sum.night += toMins(f.night);
      sum.ifr += toMins(f.ifr);
      sum.pic += toMins(f.pic);
      sum.cop += toMins(f.cop);
      sum.dual += toMins(f.dual);
      sum.fi += toMins(f.fi);
      sum.ldgDay += (parseInt(f.ldgDay,10)||0);
      sum.ldgNight += (parseInt(f.ldgNight,10)||0);
    }

    const v = (key) => (f && f[key]) ? f[key] : "";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${cellInput(idx,"date", v("date"), "DD.MM.YY", "")}</td>

      <td>${cellInput(idx,"depPlace", v("depPlace"), "ICAO", "upper")}</td>
      <td>${cellInput(idx,"out", v("out"), "HHMM", "time")}</td>

      <td>${cellInput(idx,"arrPlace", v("arrPlace"), "ICAO", "upper")}</td>
      <td>${cellInput(idx,"in", v("in"), "HHMM", "time")}</td>

      <td>${cellInput(idx,"acType", v("acType"), "B781", "upper")}</td>
      <td>${cellInput(idx,"acReg", v("acReg"), "B-17806", "upper")}</td>

      <td>${cellInput(idx,"name", v("name"), "SELF", "upper")}</td>

      <td>${cellInput(idx,"se", v("se"), "H:MM", "")}</td>
      <td>${cellInput(idx,"me", v("me"), "H:MM", "")}</td>
      <td>${cellInput(idx,"mp", v("mp"), "H:MM", "")}</td>

      <td>${cellInput(idx,"total", v("total"), "H:MM", "")}</td>

      <td>${cellInput(idx,"night", v("night"), "H:MM", "")}</td>
      <td>${cellInput(idx,"ifr", v("ifr"), "H:MM", "")}</td>

      <td>${cellInput(idx,"pic", v("pic"), "H:MM", "")}</td>
      <td>${cellInput(idx,"cop", v("cop"), "H:MM", "")}</td>
      <td>${cellInput(idx,"dual", v("dual"), "H:MM", "")}</td>
      <td>${cellInput(idx,"fi", v("fi"), "H:MM", "")}</td>

      <td>${cellInput(idx,"ldgDay", v("ldgDay"), "0", "small")}</td>
      <td>${cellInput(idx,"ldgNight", v("ldgNight"), "0", "small")}</td>

      <td>${cellInput(idx,"remarks", v("remarks"), "", "")}</td>

      <td>${f ? `<button class="del" onclick="clearRow(${idx})">√ó</button>` : ""}</td>
    `;
    tbody.appendChild(tr);
  }

  // Previous totals (manual)
  const p = {
    mp: toMins(prev.mp_me),
    total: toMins(prev.total),
    night: toMins(prev.night),
    ifr: toMins(prev.ifr),
    pic: toMins(prev.pic),
    cop: toMins(prev.cop),
    dual: toMins(prev.dual),
    fi: toMins(prev.fi),
    ldgDay: parseInt(prev.ldg_day,10)||0,
    ldgNight: parseInt(prev.ldg_night,10)||0,
    se: 0,
    me: toMins(prev.mp_me)
  };

  const grand = {
    se: sum.se + p.se,
    me: sum.me + p.me,
    mp: sum.mp + p.mp,
    total: sum.total + p.total,
    night: sum.night + p.night,
    ifr: sum.ifr + p.ifr,
    pic: sum.pic + p.pic,
    cop: sum.cop + p.cop,
    dual: sum.dual + p.dual,
    fi: sum.fi + p.fi,
    ldgDay: sum.ldgDay + p.ldgDay,
    ldgNight: sum.ldgNight + p.ldgNight
  };

  // KPI (TOTAL TO DATE)
  document.getElementById("k_total").textContent = fmtMins(grand.total);
  document.getElementById("k_pic").textContent   = fmtMins(grand.pic);
  document.getElementById("k_night").textContent = fmtMins(grand.night);
  document.getElementById("k_ifr").textContent   = fmtMins(grand.ifr);

  // Page label
  const maxPage = Math.max(1, Math.ceil(flights.length / ROWS_PER_PAGE));
  if(currentPage > maxPage) currentPage = maxPage;
  document.getElementById("pageLabel").textContent = `PAGE ${currentPage} / ${maxPage}`;

  // Footer totals
  document.getElementById("tfoot").innerHTML = `
    <tr>
      <td class="tfLabel" colspan="8">TOTAL FROM THIS PAGE</td>
      <td>${sum.se ? fmtMins(sum.se) : "‚Äî"}</td>
      <td>${sum.me ? fmtMins(sum.me) : "‚Äî"}</td>
      <td>${sum.mp ? fmtMins(sum.mp) : "‚Äî"}</td>
      <td>${sum.total ? fmtMins(sum.total) : "‚Äî"}</td>
      <td>${sum.night ? fmtMins(sum.night) : "‚Äî"}</td>
      <td>${sum.ifr ? fmtMins(sum.ifr) : "‚Äî"}</td>
      <td>${sum.pic ? fmtMins(sum.pic) : "‚Äî"}</td>
      <td>${sum.cop ? fmtMins(sum.cop) : "‚Äî"}</td>
      <td>${sum.dual ? fmtMins(sum.dual) : "‚Äî"}</td>
      <td>${sum.fi ? fmtMins(sum.fi) : "‚Äî"}</td>
      <td>${sum.ldgDay || "‚Äî"}</td>
      <td>${sum.ldgNight || "‚Äî"}</td>
      <td colspan="2"></td>
    </tr>

    <tr>
      <td class="tfLabel" colspan="8">TOTAL FROM PREVIOUS PAGE</td>
      <td>‚Äî</td>
      <td>‚Äî</td>
      <td>${p.mp ? fmtMins(p.mp) : "‚Äî"}</td>
      <td>${p.total ? fmtMins(p.total) : "‚Äî"}</td>
      <td>${p.night ? fmtMins(p.night) : "‚Äî"}</td>
      <td>${p.ifr ? fmtMins(p.ifr) : "‚Äî"}</td>
      <td>${p.pic ? fmtMins(p.pic) : "‚Äî"}</td>
      <td>${p.cop ? fmtMins(p.cop) : "‚Äî"}</td>
      <td>${p.dual ? fmtMins(p.dual) : "‚Äî"}</td>
      <td>${p.fi ? fmtMins(p.fi) : "‚Äî"}</td>
      <td>${p.ldgDay || "‚Äî"}</td>
      <td>${p.ldgNight || "‚Äî"}</td>
      <td colspan="2"></td>
    </tr>

    <tr class="grand">
      <td class="tfLabel" colspan="8">‚ñ† TOTAL TO DATE</td>
      <td>${grand.se ? fmtMins(grand.se) : "‚Äî"}</td>
      <td>${grand.me ? fmtMins(grand.me) : "‚Äî"}</td>
      <td>${grand.mp ? fmtMins(grand.mp) : "‚Äî"}</td>
      <td>${grand.total ? fmtMins(grand.total) : "‚Äî"}</td>
      <td>${grand.night ? fmtMins(grand.night) : "‚Äî"}</td>
      <td>${grand.ifr ? fmtMins(grand.ifr) : "‚Äî"}</td>
      <td>${grand.pic ? fmtMins(grand.pic) : "‚Äî"}</td>
      <td>${grand.cop ? fmtMins(grand.cop) : "‚Äî"}</td>
      <td>${grand.dual ? fmtMins(grand.dual) : "‚Äî"}</td>
      <td>${grand.fi ? fmtMins(grand.fi) : "‚Äî"}</td>
      <td>${grand.ldgDay || "‚Äî"}</td>
      <td>${grand.ldgNight || "‚Äî"}</td>
      <td colspan="2"></td>
    </tr>
  `;

  saveJSON(KEY_FLIGHTS, flights);
}

/* =========================
   Modal
   ========================= */
function openModal(){
  document.getElementById("overlay").classList.add("open");
  renderAttachPreview();
}
function closeModal(){
  document.getElementById("overlay").classList.remove("open");
}
function overlayClick(e){
  if(e.target.id==="overlay") closeModal();
}

/* =========================
   Add Flight (fills first empty row on current page)
   ========================= */
function saveFromModal(){
  const get = id => document.getElementById(id).value.trim();

  const out = get("f_out");
  const inn = get("f_in");
  const block = calcBlock(out, inn);
  const blockStr = block!==null ? fmtMins(block) : "";

  const total = get("f_total") || blockStr;
  const mp    = get("f_mp") || total;
  const se    = get("f_se");
  const me    = get("f_me") || (!se ? mp : "");

  const ifr   = get("f_ifr") || total;
  const pic   = get("f_pic") || total;

  const row = {
    id: Date.now() + Math.floor(Math.random()*100000),
    date: get("f_date"),
    depPlace: up(get("f_dep")),
    out: out,
    arrPlace: up(get("f_arr")),
    in: inn,
    acType: up(get("f_type")),
    acReg: up(get("f_reg")),
    name: up(get("f_name") || "SELF"),
    se: se,
    me: me,
    mp: mp,
    total: total,
    night: get("f_night"),
    ifr: ifr,
    pic: pic,
    cop: get("f_cop"),
    dual: get("f_dual"),
    fi: get("f_fi"),
    ldgDay: get("f_ldg_day") || "0",
    ldgNight: get("f_ldg_night") || "0",
    remarks: get("f_rem")
  };

  const start = (currentPage - 1) * ROWS_PER_PAGE;
  const end = start + ROWS_PER_PAGE;

  // make sure placeholders exist
  if (flights.length < end) {
    for (let i = flights.length; i < end; i++) flights.push(null);
  }

  let placed = false;
  for(let i=start; i<end; i++){
    if(!flights[i]){
      flights[i] = row;
      placed = true;
      break;
    }
  }

  if(!placed){
    // current page full -> next page, first row
    setPage(currentPage + 1);
    const newStart = (currentPage - 1) * ROWS_PER_PAGE;
    const newEnd = newStart + ROWS_PER_PAGE;
    if (flights.length < newEnd) {
      for (let i = flights.length; i < newEnd; i++) flights.push(null);
    }
    flights[newStart] = row;
  }

  saveJSON(KEY_FLIGHTS, flights);
  closeModal();
  render();
}

/* =========================
   Attachments (local preview only)
   ========================= */
document.getElementById("photoInput").addEventListener("change", (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  const r = new FileReader();
  r.onload = ()=>{
    attach.photoDataUrl = String(r.result || "");
    saveJSON(KEY_ATTACH, attach);
    renderAttachPreview();
  };
  r.readAsDataURL(file);
});

document.getElementById("pdfInput").addEventListener("change", (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  attach.pdfName = file.name || "logbook.pdf";
  saveJSON(KEY_ATTACH, attach);
  renderAttachPreview();
});

function renderAttachPreview(){
  const p = document.getElementById("photoPrev");
  if(attach.photoDataUrl){
    p.style.display = "block";
    p.innerHTML = `<img src="${attach.photoDataUrl}" alt="photo preview">`;
  }else{
    p.style.display = "none";
    p.innerHTML = "";
  }
  document.getElementById("pdfName").textContent = attach.pdfName ? ("Selected PDF: " + attach.pdfName) : "";
}

/* =========================
   Backup / Restore
   ========================= */
function exportBackup(){
  const payload = {
    flights,
    prev,
    theme: document.body.classList.contains("light") ? "light" : "dark",
    page: currentPage
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "mara-logbook-backup.json";
  a.click();
}
function importBackup(){
  const input = document.createElement("input");
  input.type="file";
  input.accept=".json,application/json";
  input.onchange = ()=>{
    const file = input.files && input.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const obj = JSON.parse(String(r.result||"{}"));
        if(Array.isArray(obj.flights)) flights = obj.flights;
        if(obj.prev) prev = obj.prev;

        saveJSON(KEY_FLIGHTS, flights);
        saveJSON(KEY_PREV, prev);

        if(obj.theme) applyTheme(obj.theme === "light" ? "light" : "dark");
        if(obj.page) setPage(parseInt(obj.page,10) || 1);

        renderPrev();
        render();
      }catch(e){
        alert("Backup file not valid.");
      }
    };
    r.readAsText(file);
  };
  input.click();
}
function resetAll(){
  if(!confirm("Reset ALL data (flights + previous totals + attachments)?")) return;

  localStorage.removeItem(KEY_FLIGHTS);
  localStorage.removeItem(KEY_PREV);
  localStorage.removeItem(KEY_ATTACH);
  localStorage.removeItem(KEY_PAGE);

  flights = [];
  prev = {
    mp_me: "0:00",
    total: "0:00",
    night: "0:00",
    ifr: "0:00",
    pic: "0:00",
    cop: "0:00",
    dual: "0:00",
    fi: "",
    ldg_day: "0",
    ldg_night: "0"
  };
  attach = { photoDataUrl:"", pdfName:"" };
  currentPage = 1;

  saveJSON(KEY_FLIGHTS, flights);
  saveJSON(KEY_PREV, prev);
  saveJSON(KEY_ATTACH, attach);
  localStorage.setItem(KEY_PAGE, "1");

  renderPrev();
  render();
}

/* =========================
   Import sample flights (from your photo page)
   NOTE: This is the same ‚Äúseed‚Äù list we used earlier.
   You can edit any cell after import.
   ========================= */
function seedFromPhoto(){
  if(!confirm("Import the 10 flights from your logbook photo page into Page 1?")) return;

  const seeded = [
    {date:"23.11", depPlace:"RCTP", out:"1300", arrPlace:"VTBS", in:"1642", acType:"B781", acReg:"B-17812", name:"SELF", total:"3:42", mp:"3:42", me:"3:42", night:"3:42", ifr:"3:42", pic:"3:42", ldgDay:"0", ldgNight:"0"},
    {date:"24.11", depPlace:"VTBS", out:"1957", arrPlace:"RCTP", in:"2329", acType:"B781", acReg:"B-17810", name:"SELF", total:"3:32", mp:"3:32", me:"3:32", night:"2:32", ifr:"3:32", pic:"3:32", ldgDay:"1", ldgNight:"0"},
    {date:"26.11", depPlace:"RCTP", out:"0735", arrPlace:"RKSI", in:"0957", acType:"B789", acReg:"B-17883", name:"SELF", total:"2:22", mp:"2:22", me:"2:22", night:"2:22", ifr:"2:22", pic:"2:22", ldgDay:"0", ldgNight:"1"},
    {date:"26.11", depPlace:"RKSI", out:"1114", arrPlace:"RCTP", in:"1415", acType:"B789", acReg:"B-17883", name:"SELF", total:"3:01", mp:"3:01", me:"3:01", night:"",    ifr:"3:01", pic:"3:01", ldgDay:"0", ldgNight:"0"},
    {date:"01.12", depPlace:"RCTP", out:"0732", arrPlace:"RKSI", in:"0951", acType:"B781", acReg:"B-17815", name:"SELF", total:"2:19", mp:"2:19", me:"2:19", night:"1:19", ifr:"2:19", pic:"2:19", ldgDay:"0", ldgNight:"1"},
    {date:"01.12", depPlace:"RKSI", out:"1059", arrPlace:"RCTP", in:"1338", acType:"B781", acReg:"B-17815", name:"SELF", total:"2:38", mp:"2:38", me:"2:38", night:"2:38", ifr:"2:38", pic:"2:38", ldgDay:"0", ldgNight:"0"},
    {date:"04.12", depPlace:"VTBS", out:"1945", arrPlace:"LOWW", in:"0649", acType:"B781", acReg:"B-17883", name:"SELF", total:"11:25",mp:"11:25",me:"11:25",night:"7:00", ifr:"11:25",pic:"11:25",ldgDay:"1",ldgNight:"0"},
    {date:"07.12", depPlace:"LOWW", out:"1657", arrPlace:"VTBS", in:"0308", acType:"B781", acReg:"B-17883", name:"SELF", total:"10:11",mp:"10:11",me:"10:11",night:"7:30", ifr:"10:11",pic:"10:11",ldgDay:"0",ldgNight:"0"},
    {date:"12.12", depPlace:"WSSS", out:"1924", arrPlace:"RCTP", in:"2359", acType:"B789", acReg:"B-17887", name:"SELF", total:"4:25", mp:"4:25", me:"4:25", night:"9:25", ifr:"4:25", pic:"4:25", ldgDay:"0", ldgNight:"1"},
    {date:"17.12", depPlace:"RCTP", out:"1153", arrPlace:"KDFW", in:"0112", acType:"B789", acReg:"B-17886", name:"SELF", total:"14:19",mp:"14:19",me:"14:19",night:"5:00", ifr:"14:19",pic:"14:19",ldgDay:"0",ldgNight:"0"}
  ];

  // Reset to exactly one page of placeholders, then fill 10 rows
  flights = [];
  for(let i=0;i<ROWS_PER_PAGE;i++) flights.push(null);

  seeded.forEach((x,i)=>{
    flights[i] = {
      id: Date.now() + Math.floor(Math.random()*100000),
      date: x.date,
      depPlace: x.depPlace,
      out: x.out,
      arrPlace: x.arrPlace,
      in: x.in,
      acType: x.acType,
      acReg: x.acReg,
      name: x.name,
      se: "",
      me: x.me,
      mp: x.mp,
      total: x.total,
      night: x.night,
      ifr: x.ifr,
      pic: x.pic,
      cop: "",
      dual: "",
      fi: "",
      ldgDay: x.ldgDay,
      ldgNight: x.ldgNight,
      remarks: ""
    };
  });

  currentPage = 1;
  localStorage.setItem(KEY_PAGE, "1");
  saveJSON(KEY_FLIGHTS, flights);
  render();
}

/* =========================
   Init
   ========================= */
function escapeHTML(s){
  return String(s||"").replace(/[&<>"']/g, m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

applyTheme(localStorage.getItem(KEY_THEME) || "dark");
renderPrev();
render();
</script>

</body>
</html>
