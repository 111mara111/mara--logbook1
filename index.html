<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mara Pilot Logbook</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">

  <!-- iOS Home Screen -->
  <link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">

  <!-- Browser Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Mara Logbook">
  <meta name="theme-color" content="#163a6b">

  <style>
    :root{
      --bg:#f4f7ff;
      --panel:#ffffff;
      --ink:#0b1b33;
      --blue:#163a6b;
      --line:rgba(11,27,51,.12);
    }

    body.dark{
      --bg:#0a1628;
      --panel:#0d2045;
      --ink:#f0f4ff;
      --blue:#8fb6ff;
      --line:rgba(240,244,255,.15);
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background:var(--bg);
      color:var(--ink);
    }

    .header{
      padding:14px;
      background:var(--panel);
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    h1{
      margin:0;
      font-size:18px;
      letter-spacing:2px;
      color:var(--blue);
    }

    button{
      padding:8px 12px;
      font-weight:bold;
      border-radius:8px;
      border:1px solid var(--line);
      background:var(--panel);
      cursor:pointer;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }

    th,td{
      border:1px solid var(--line);
      padding:6px;
      text-align:center;
    }

    th{
      background:rgba(22,58,107,.08);
      color:var(--blue);
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:1px;
    }

    input{
      width:100%;
      border:none;
      background:transparent;
      color:var(--ink);
      text-align:center;
      font-weight:bold;
    }

    tfoot td{
      font-weight:bold;
      background:rgba(22,58,107,.08);
    }

    @media print{
      button{display:none}
      @page{size:A4 landscape;margin:10mm}
    }
  </style>
</head>

<body>

<div class="header">
  <h1>âœˆ MARA PILOT LOGBOOK</h1>
  <div>
    <button onclick="toggleTheme()" id="themeBtn">DARK</button>
    <button onclick="addRow()">+ Flight</button>
    <button onclick="window.print()">Export PDF</button>
  </div>
</div>

<table>
<thead>
<tr>
<th>Date</th>
<th>From</th>
<th>Out</th>
<th>To</th>
<th>In</th>
<th>Total</th>
<th>Night</th>
<th>IFR</th>
<th>PIC</th>
<th>LDG Day</th>
<th>LDG Night</th>
<th></th>
</tr>
</thead>

<tbody id="tbody"></tbody>

<tfoot>
<tr>
<td colspan="5">TOTAL</td>
<td id="t_total"></td>
<td id="t_night"></td>
<td id="t_ifr"></td>
<td id="t_pic"></td>
<td id="t_ldg_d"></td>
<td id="t_ldg_n"></td>
<td></td>
</tr>
</tfoot>

</table>

<script>
const KEY="mara_logbook_v2";

let flights=JSON.parse(localStorage.getItem(KEY))||[];

function save(){localStorage.setItem(KEY,JSON.stringify(flights));}

function toMin(t){
if(!t)return 0;
if(t.includes(":")){
let p=t.split(":");
return parseInt(p[0])*60+parseInt(p[1]);
}
return 0;
}

function fmt(m){
if(!m)return "";
let h=Math.floor(m/60);
let mm=m%60;
return h+":"+(mm<10?"0":"")+mm;
}

function calc(out,inT){
if(!out||!inT)return "";
let o=parseInt(out.slice(0,2))*60+parseInt(out.slice(2));
let i=parseInt(inT.slice(0,2))*60+parseInt(inT.slice(2));
if(i<o)i+=1440;
return fmt(i-o);
}

function render(){
let tb=document.getElementById("tbody");
tb.innerHTML="";
let totals={total:0,night:0,ifr:0,pic:0,ldgD:0,ldgN:0};

flights.forEach((f,i)=>{
totals.total+=toMin(f.total);
totals.night+=toMin(f.night);
totals.ifr+=toMin(f.ifr);
totals.pic+=toMin(f.pic);
totals.ldgD+=parseInt(f.ldgD||0);
totals.ldgN+=parseInt(f.ldgN||0);

tb.innerHTML+=`
<tr>
<td><input value="${f.date||""}" oninput="update(${i},'date',this.value)"></td>
<td><input value="${f.from||""}" oninput="update(${i},'from',this.value)"></td>
<td><input value="${f.out||""}" oninput="update(${i},'out',this.value)"></td>
<td><input value="${f.to||""}" oninput="update(${i},'to',this.value)"></td>
<td><input value="${f.in||""}" oninput="update(${i},'in',this.value)"></td>
<td><input value="${f.total||""}" oninput="update(${i},'total',this.value)"></td>
<td><input value="${f.night||""}" oninput="update(${i},'night',this.value)"></td>
<td><input value="${f.ifr||""}" oninput="update(${i},'ifr',this.value)"></td>
<td><input value="${f.pic||""}" oninput="update(${i},'pic',this.value)"></td>
<td><input value="${f.ldgD||0}" oninput="update(${i},'ldgD',this.value)"></td>
<td><input value="${f.ldgN||0}" oninput="update(${i},'ldgN',this.value)"></td>
<td><button onclick="del(${i})">X</button></td>
</tr>
`;
});

document.getElementById("t_total").innerText=fmt(totals.total);
document.getElementById("t_night").innerText=fmt(totals.night);
document.getElementById("t_ifr").innerText=fmt(totals.ifr);
document.getElementById("t_pic").innerText=fmt(totals.pic);
document.getElementById("t_ldg_d").innerText=totals.ldgD;
document.getElementById("t_ldg_n").innerText=totals.ldgN;

save();
}

function update(i,key,val){
flights[i][key]=val;
if(key==="out"||key==="in"){
let block=calc(flights[i].out,flights[i].in);
if(block){
flights[i].total=block;
if(!flights[i].ifr)flights[i].ifr=block;
if(!flights[i].pic)flights[i].pic=block;
}
}
render();
}

function addRow(){
flights.push({});
render();
}

function del(i){
flights.splice(i,1);
render();
}

function toggleTheme(){
let dark=document.body.classList.toggle("dark");
document.getElementById("themeBtn").innerText=dark?"LIGHT":"DARK";
localStorage.setItem("theme",dark?"dark":"light");
}

if(localStorage.getItem("theme")==="dark"){
document.body.classList.add("dark");
document.getElementById("themeBtn").innerText="LIGHT";
}

render();

/* Service Worker (GitHub safe) */
if ("serviceWorker" in navigator && location.protocol !== "file:") {
navigator.serviceWorker.register("./service-worker.js");
}
</script>

</body>
</html>
